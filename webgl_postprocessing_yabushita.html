<!DOCTYPE html>
<html lang="en">
  <head>
    <title>three.js webgl - postprocessing</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <link type="text/css" rel="stylesheet" href="style.css" />
    <style>
      .wrap {
        /* background-image: linear-gradient(0deg, transparent 31px, #ddd 32px),
          linear-gradient(90deg, transparent 31px, #ddd 32px);
        background-size: 32px 32px; */
        background: linear-gradient(135deg, #e3bbf4 0.82%, #d2dfff 100%);
      }
      #three canvas {
        opacity: 0.4;
        background: linear-gradient(135deg, #e3bbf4 0.82%, #d2dfff 100%);
        /* background-color: #000; */
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div id="three"></div>
    </div>

    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script
      async
      src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
    ></script>

    <script type="importmap">
      {
        "imports": {
          "three": "../build/three.module.js"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";

      import Stats from "./jsm/libs/stats.module.js";

      import { OrbitControls } from "./jsm/controls/OrbitControls.js";

      import { EffectComposer } from "./jsm/postprocessing/EffectComposer.js";
      import { RenderPass } from "./jsm/postprocessing/RenderPass.js";
      import { ShaderPass } from "./jsm/postprocessing/ShaderPass.js";
      import { BloomPass } from "./jsm/postprocessing/BloomPass.js";
      import { FilmPass } from "./jsm/postprocessing/FilmPass.js";
      import { DotScreenPass } from "./jsm/postprocessing/DotScreenPass.js";
      //エフェクトファイルを読み込み
      import { HalftonePass } from "./jsm/postprocessing/HalftonePass.js";
      import { GlitchPass } from "./jsm/postprocessing/GlitchPass.js";
      import {
        MaskPass,
        ClearMaskPass,
      } from "./jsm/postprocessing/MaskPass.js";
      import { TexturePass } from "./jsm/postprocessing/TexturePass.js";

      import { BleachBypassShader } from "./jsm/shaders/BleachBypassShader.js";
      import { ColorifyShader } from "./jsm/shaders/ColorifyShader.js";
      import { HorizontalBlurShader } from "./jsm/shaders/HorizontalBlurShader.js";
      import { VerticalBlurShader } from "./jsm/shaders/VerticalBlurShader.js";
      import { SepiaShader } from "./jsm/shaders/SepiaShader.js";
      import { VignetteShader } from "./jsm/shaders/VignetteShader.js";
      import { GammaCorrectionShader } from "./jsm/shaders/GammaCorrectionShader.js";
      import { RGBShiftShader } from "./jsm/shaders/RGBShiftShader.js";
      import { DotScreenShader } from "./jsm/shaders/DotScreenShader.js";

      import { GLTFLoader } from "./jsm/loaders/GLTFLoader.js";

      const W_WIDTH = window.innerWidth; // ブラウザの横サイズ
      const W_HEIGHT = window.innerHeight; // ブラウザの縦サイズ
      const W_ASPECT = window.innerWidth / window.innerHeight; // アスペクト比
      const W_RATIO = window.devicePixelRatio; // ピクセル比
      let camera, scene, renderer, mesh, composer, controls; // カメラ、シーン、レンダラー、地球

      window.onload = () => {
        init();
        animate();
      };

      function init() {
        // 1, カメラを作る
        camera = new THREE.PerspectiveCamera(50, W_ASPECT, 1, 1000);
        camera.position.set(0, 0, 400);

        // 2, シーンを作る
        scene = new THREE.Scene();

        // 3-1, ライトを作る1
        let dirLight = new THREE.DirectionalLight(0x7a77ff, 2);
        dirLight.position.set(5, 3, 2); // 光の向き
        scene.add(dirLight);

        // 3-2, ライトを作る2
        let ambLight = new THREE.AmbientLight(0xff76bb, 1);
        scene.add(ambLight);

        // 4, レンダラーを作る
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(W_RATIO); // ピクセル比
        renderer.setSize(W_WIDTH, W_HEIGHT);

        // controls
        controls = new OrbitControls(camera, renderer.domElement);

        // 5, HTMLに配置する
        let div = document.getElementById("three");
        div.appendChild(renderer.domElement);

        // 1, テクスチャ
        let txLoader = new THREE.TextureLoader();

        // 2, ジオメトリ
        // let geometry = new THREE.SphereBufferGeometry(100, 30, 30);
        let geometry = new THREE.TorusGeometry(100, 20, 80, 3000);

        // 3, マテリアル
        let material = new THREE.MeshToonMaterial({
          color: 0x7a77ff,
        });

        // 4, メッシュ
        mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        // postprocessing
        composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));

        // const effect1 = new ShaderPass(DotScreenShader);
        // effect1.uniforms["scale"].value = 0;
        // composer.addPass(effect1);

        // const effect2 = new ShaderPass(RGBShiftShader);
        // effect2.uniforms["amount"].value = 0.001;
        // composer.addPass(effect2);
      }

      // 追加 マウスの動きを取得
      let mouseX = 0,
        mouseY = 0; // マウス座標

      let windowHalfX = window.innerWidth / 2;
      let windowHalfY = 200;

      function onDocumentMouseMove(event) {
        mouseX = event.clientX - windowHalfX;
        mouseY = event.clientY - windowHalfY;
      }
      document.addEventListener("mousemove", onDocumentMouseMove);

      function animate() {
        requestAnimationFrame(animate); // 更新

        mesh.rotation.y += 0.003; // 5, 地球を回転させる

        camera.position.x += (mouseX - camera.position.x) * 0.05;
        camera.position.y += (-mouseY - camera.position.y) * 0.05;

        // 原点方向を見つめる
        camera.lookAt(scene.position);
        renderer.render(scene, camera); // レンダリング

        // 追加 3Dオブジェクトが回転する
        mesh.rotation.y += 0.005;
        mesh.rotation.x += 0.005;

        composer.render(); //エフェクト
      }
    </script>
  </body>
</html>
